<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng C·∫£nh B√°o Ch√°y Th√¥ng Minh</title>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        h1 { text-align: center; color: #d32f2f; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Layout 2 c·ªôt */
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        /* Card Style */
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .card h2 { font-size: 16px; color: #888; margin: 0 0 15px 0; font-weight: 600; text-transform: uppercase; }
        .value-display { font-size: 42px; font-weight: bold; color: #333; margin: 5px 0; }
        .status-text { font-size: 14px; color: #666; margin-top: 5px; }

        /* Alert Mode */
        .alert-mode { background-color: #ff4d4d !important; color: white !important; animation: pulse 1s infinite; }
        .alert-mode h2, .alert-mode .value-display, .alert-mode .status-text { color: white !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Controls */
        .control-group { margin-top: auto; padding-top: 15px; }
        input { width: 60%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-size: 14px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #0056b3; }

        /* Status Badge */
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; color: white; margin-bottom: 20px; transition: 0.3s; }
        .status-online { background-color: #28a745; box-shadow: 0 0 10px #28a745; }
        .status-offline { background-color: #dc3545; box-shadow: 0 0 10px #dc3545; }
    </style>
</head>
<body>

    <h1>üî• H·ªá Th·ªëng Gi√°m S√°t An To√†n</h1>
    
    <div style="text-align: center;">
        <span id="connectionStatus" class="status-badge status-offline">üî¥ ƒêang t√¨m thi·∫øt b·ªã...</span>
    </div>
    
    <div class="container">
        
        <div class="card" id="tempCard">
            <h2>üå° Nhi·ªát ƒë·ªô</h2>
            <div class="value-display" id="tempValue">-- ¬∞C</div>
            <div class="status-text" id="tempStatus">ƒêang t·∫£i...</div>
        </div>

        <div class="card" id="smokeCard">
            <h2>üí® N·ªìng ƒë·ªô Kh√≥i</h2>
            <div class="value-display" id="smokeValue">-- ppm</div>
            <div class="status-text" id="smokeStatus">ƒêang t·∫£i...</div>
        </div>

        <div class="card" id="gasCard">
            <h2>‚ò† Kh√≠ Gas</h2>
            <div class="value-display" id="gasValue">-- ppm</div>
            <div class="status-text" id="gasStatus">ƒêang t·∫£i...</div>
        </div>

        <div class="card" id="flameCard">
            <h2>üî• C·∫£m bi·∫øn L·ª≠a</h2>
            <div class="value-display" id="flameValue">--</div>
            <div class="status-text" id="flameStatus">ƒêang t·∫£i...</div>
        </div>

        <div class="card">
            <h2>‚öô Ng∆∞·ª°ng Nhi·ªát</h2>
            <div style="margin-bottom:10px;">Hi·ªán t·∫°i: <b id="thresTemp" style="color:red">--</b></div>
            <div class="control-group">
                <input type="number" id="newThresTemp" placeholder="M·ª©c c·∫£nh b√°o...">
                <button onclick="updateVal('Threshold', 'newThresTemp')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öô Ng∆∞·ª°ng Kh√≥i</h2>
            <div style="margin-bottom:10px;">Hi·ªán t·∫°i: <b id="thresSmoke" style="color:red">--</b></div>
            <div class="control-group">
                <input type="number" id="newThresSmoke" placeholder="M·ª©c c·∫£nh b√°o...">
                <button onclick="updateVal('SmokeThreshold', 'newThresSmoke')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öô Ng∆∞·ª°ng Gas</h2>
            <div style="margin-bottom:10px;">Hi·ªán t·∫°i: <b id="thresGas" style="color:red">--</b></div>
            <div class="control-group">
                <input type="number" id="newThresGas" placeholder="M·ª©c c·∫£nh b√°o...">
                <button onclick="updateVal('GasThreshold', 'newThresGas')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öô Ng∆∞·ª°ng L·ª≠a</h2>
            <div style="margin-bottom:10px;">Hi·ªán t·∫°i: <b id="thresFlame" style="color:red">--</b></div>
            <div class="control-group">
                <input type="number" id="newThresFlame" placeholder="M·ª©c c·∫£nh b√°o...">
                <button onclick="updateVal('FlameThreshold', 'newThresFlame')">L∆∞u</button>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk",
            authDomain: "fire-warning-3f43e.firebaseapp.com",
            databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-warning-3f43e",
            storageBucket: "fire-warning-3f43e.firebasestorage.app",
            messagingSenderId: "216206579900",
            appId: "1:216206579900:web:aa5f46d236923b921418b9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Bi·∫øn l∆∞u tr·ªØ gi√° tr·ªã hi·ªán t·∫°i
        let data = { temp:0, smoke:0, gas:0, flame:0 };
        let limits = { temp:100, smoke:100, gas:100, flame:100 };
        let lastUpdate = 0;
        const timeoutLimit = 12000;

        // --- H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN CHUNG ---
        function updateUI(type, val, limit, cardId, statusId, unit) {
            let card = document.getElementById(cardId);
            let status = document.getElementById(statusId);
            
            // C·∫≠p nh·∫≠t s·ªë li·ªáu
            document.getElementById(type + "Value").innerText = val + (unit ? " " + unit : "");
            
            // Ki·ªÉm tra c·∫£nh b√°o (L·ª≠a th∆∞·ªùng ng∆∞·ª£c l·∫°i: Th·∫•p l√† ch√°y)
            let isAlert = false;
            if (type === 'flame') {
                isAlert = (val < limit); // C·∫£m bi·∫øn l·ª≠a: Gi√° tr·ªã c√†ng nh·ªè -> C√†ng g·∫ßn l·ª≠a
            } else {
                isAlert = (val >= limit);
            }

            if(isAlert) {
                card.classList.add("alert-mode");
                status.innerText = "‚ö†Ô∏è NGUY HI·ªÇM !!!";
            } else {
                card.classList.remove("alert-mode");
                status.innerText = "B√¨nh th∆∞·ªùng";
            }
            lastUpdate = Date.now();
        }

        // --- L·∫ÆNG NGHE D·ªÆ LI·ªÜU C·∫¢M BI·∫æN ---
        db.ref("Temperature").on("value", snap => {
            data.temp = snap.val() || 0;
            updateUI('temp', data.temp, limits.temp, 'tempCard', 'tempStatus', '¬∞C');
        });

        db.ref("Smoke").on("value", snap => {
            data.smoke = snap.val() || 0;
            updateUI('smoke', data.smoke, limits.smoke, 'smokeCard', 'smokeStatus', 'ppm');
        });

        db.ref("Gas").on("value", snap => {
            data.gas = snap.val() || 0;
            updateUI('gas', data.gas, limits.gas, 'gasCard', 'gasStatus', 'ppm');
        });

        db.ref("Flame").on("value", snap => {
            data.flame = snap.val() || 0; // Gi√° tr·ªã analog 0-4095
            updateUI('flame', data.flame, limits.flame, 'flameCard', 'flameStatus', '');
        });

        // --- L·∫ÆNG NGHE NG∆Ø·ª†NG C√ÄI ƒê·∫∂T ---
        db.ref("Threshold").on("value", snap => { 
            limits.temp = snap.val(); 
            document.getElementById("thresTemp").innerText = limits.temp;
            updateUI('temp', data.temp, limits.temp, 'tempCard', 'tempStatus', '¬∞C');
        });
        db.ref("SmokeThreshold").on("value", snap => { 
            limits.smoke = snap.val(); 
            document.getElementById("thresSmoke").innerText = limits.smoke;
            updateUI('smoke', data.smoke, limits.smoke, 'smokeCard', 'smokeStatus', 'ppm');
        });
        db.ref("GasThreshold").on("value", snap => { 
            limits.gas = snap.val(); 
            document.getElementById("thresGas").innerText = limits.gas;
            updateUI('gas', data.gas, limits.gas, 'gasCard', 'gasStatus', 'ppm');
        });
        db.ref("FlameThreshold").on("value", snap => { 
            limits.flame = snap.val(); 
            document.getElementById("thresFlame").innerText = limits.flame;
            updateUI('flame', data.flame, limits.flame, 'flameCard', 'flameStatus', '');
        });

        // --- H√ÄM G·ª¨I D·ªÆ LI·ªÜU L√äN FIREBASE (D√πng chung cho g·ªçn) ---
        function updateVal(path, inputId) {
            let val = document.getElementById(inputId).value;
            if(val) {
                db.ref(path).set(Number(val));
                alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                document.getElementById(inputId).value = "";
            }
        }

        // --- KI·ªÇM TRA K·∫æT N·ªêI ---
        setInterval(() => {
            let badge = document.getElementById("connectionStatus");
            if (Date.now() - lastUpdate < timeoutLimit) {
                if (badge.innerText !== "üü¢ ƒêang k·∫øt n·ªëi") {
                    badge.className = "status-badge status-online";
                    badge.innerText = "üü¢ ƒêang k·∫øt n·ªëi";
                }
            } else {
                if (badge.innerText !== "üî¥ M·∫•t k·∫øt n·ªëi (Offline)") {
                    badge.className = "status-badge status-offline";
                    badge.innerText = "üî¥ M·∫•t k·∫øt n·ªëi (Offline)";
                }
            }
        }, 1000);

    </script>
</body>
</html>
