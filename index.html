<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng C·∫£nh B√°o Ch√°y</title>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
        
        /* --- GIAO DI·ªÜN ƒêƒÇNG NH·∫¨P (LOGIN SCREEN) --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #d32f2f, #1976d2);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; /* Lu√¥n n·∫±m tr√™n c√πng */
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px;
        }
        .login-box h2 { margin-top: 0; color: #333; }
        .login-box input {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
        }
        .login-box button {
            width: 100%; padding: 12px; background: #d32f2f; color: white;
            border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        .login-box button:hover { background: #b71c1c; }

        /* --- GIAO DI·ªÜN CH√çNH (MAIN APP) --- */
        #mainApp {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            padding: 20px;
            flex-grow: 1;
        }
        
        h1 { text-align: center; color: #d32f2f; margin-bottom: 20px; text-transform: uppercase; }
        
        /* Header ch·ª©a n√∫t ƒëƒÉng xu·∫•t */
        .app-header {
            display: flex; justify-content: flex-end; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 20px;
        }
        .btn-logout { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin: 0 auto; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
        
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .card h2 { font-size: 18px; margin-bottom: 10px; color: #444; }
        .value-display { font-size: 40px; font-weight: bold; margin: 5px 0 10px 0; }
        .status-text { font-size: 14px; color: #666; }
        
        .threshold-box { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
        .threshold-box input { width: 50%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .threshold-box button { padding: 8px 12px; border: none; background: #1976d2; color: white; border-radius: 5px; cursor: pointer; }
        .threshold-value { color: red; font-weight: bold; }

        .alert-mode { background-color: #ff4d4d !important; color: white !important; animation: pulse 1.5s infinite; }
        .alert-mode h2, .alert-mode .value-display, .alert-mode .status-text { color: white !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .status-badge { padding: 6px 15px; border-radius: 20px; color: white; font-weight: bold; }
        .status-offline { background: #d32f2f; }
        .status-online { background: #2e7d32; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2>üîí ƒêƒÇNG NH·∫¨P</h2>
            <p style="font-size:13px; color:#666;">H·ªá th·ªëng gi√°m s√°t an to√†n</p>
            <input type="email" id="email" placeholder="Nh·∫≠p Email">
            <input type="password" id="password" placeholder="Nh·∫≠p M·∫≠t kh·∫©u">
            <button onclick="login()">V√ÄO H·ªÜ TH·ªêNG</button>
            <p id="loginError" style="color:red; font-size:13px; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div id="mainApp">
        <div class="app-header">
            <span style="margin-right: 15px;">Xin ch√†o, <b>Admin</b></span>
            <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <h1>üî• H·ªá Th·ªëng C·∫£nh B√°o Ch√°y</h1>
        
        <div style="text-align:center; margin-bottom: 20px;">
            <span id="connectionStatus" class="status-badge status-offline">üî¥ ƒêang t√¨m thi·∫øt b·ªã...</span>
        </div>

        <div class="container">
            <div class="card">
                <div class="sensor-section" id="tempSensor">
                    <h2>üå° Nhi·ªát ƒë·ªô</h2>
                    <div class="value-display" id="tempValue">-- ¬∞C</div>
                    <div class="status-text" id="tempStatus">ƒêang t·∫£i...</div>
                </div>
                <div class="threshold-box">
                    <div>Ng∆∞·ª°ng: <b id="thresTemp" class="threshold-value">--</b></div>
                    <input type="number" id="newThresTemp" placeholder="ƒê·∫∑t m·ª©c...">
                    <button onclick="updateVal('Threshold','newThresTemp')">L∆∞u</button>
                </div>
            </div>
            
            <div class="card">
                <div class="sensor-section" id="smokeSensor">
                    <h2>üí® Kh√≥i</h2>
                    <div class="value-display" id="smokeValue">-- ppm</div>
                    <div class="status-text" id="smokeStatus">ƒêang t·∫£i...</div>
                </div>
                <div class="threshold-box">
                    <div>Ng∆∞·ª°ng: <b id="thresSmoke" class="threshold-value">--</b></div>
                    <input type="number" id="newThresSmoke" placeholder="ƒê·∫∑t m·ª©c...">
                    <button onclick="updateVal('SmokeThreshold','newThresSmoke')">L∆∞u</button>
                </div>
            </div>

            <div class="card">
                <div class="sensor-section" id="gasSensor">
                    <h2>‚ò† Gas</h2>
                    <div class="value-display" id="gasValue">-- ppm</div>
                    <div class="status-text" id="gasStatus">ƒêang t·∫£i...</div>
                </div>
                <div class="threshold-box">
                    <div>Ng∆∞·ª°ng: <b id="thresGas" class="threshold-value">--</b></div>
                    <input type="number" id="newThresGas" placeholder="ƒê·∫∑t m·ª©c...">
                    <button onclick="updateVal('GasThreshold','newThresGas')">L∆∞u</button>
                </div>
            </div>

            <div class="card">
                <div class="sensor-section" id="flameSensor">
                    <h2>üî• L·ª≠a</h2>
                    <div class="value-display" id="flameValue">--</div>
                    <div class="status-text" id="flameStatus">ƒêang t·∫£i...</div>
                </div>
                <div class="threshold-box">
                    <div>Ng∆∞·ª°ng: <b id="thresFlame" class="threshold-value">--</b></div>
                    <input type="number" id="newThresFlame" placeholder="ƒê·∫∑t m·ª©c...">
                    <button onclick="updateVal('FlameThreshold','newThresFlame')">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk",
            authDomain: "fire-warning-3f43e.firebaseapp.com",
            databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-warning-3f43e",
            storageBucket: "fire-warning-3f43e.firebasestorage.app",
            messagingSenderId: "216206579900",
            appId: "1:216206579900:web:aa5f46d236923b921418b9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- X·ª¨ L√ù LOGIN / LOGOUT ---
        const loginScreen = document.getElementById("loginScreen");
        const mainApp = document.getElementById("mainApp");
        const loginError = document.getElementById("loginError");

        function login() {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            loginError.style.display = "none";

            if(!e || !p) {
                loginError.innerText = "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!";
                loginError.style.display = "block";
                return;
            }

            auth.signInWithEmailAndPassword(e, p)
                .catch((error) => {
                    loginError.innerText = "Sai email ho·∫∑c m·∫≠t kh·∫©u!";
                    loginError.style.display = "block";
                });
        }

        function logout() {
            auth.signOut();
        }

        // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë·ªÉ chuy·ªÉn m√†n h√¨nh
        auth.onAuthStateChanged((user) => {
            if (user) {
                // ƒê√£ ƒëƒÉng nh·∫≠p -> ·∫®n Login, Hi·ªán Main App
                loginScreen.style.display = "none";
                mainApp.style.display = "block";
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p -> Hi·ªán Login, ·∫®n Main App
                loginScreen.style.display = "flex";
                mainApp.style.display = "none";
            }
        });

        // --- CODE X·ª¨ L√ù SENSOR (Ch·ªâ ch·∫°y ng·∫ßm, hi·ªÉn th·ªã khi mainApp hi·ªán) ---
        let data = { temp:0, smoke:0, gas:0, flame:0 };
        let limits = { temp:100, smoke:100, gas:100, flame:100 };
        let lastUpdate = 0; 
        const timeoutLimit = 12000;

        function updateUI(type, val, limit, sensorId, valueId, statusId, unit) {
            document.getElementById(valueId).innerText = val + (unit ? " " + unit : "");
            let sensorSection = document.getElementById(sensorId);
            let status = document.getElementById(statusId);
            
            let alert = (type === "flame") ? (val < limit) : (val >= limit);
            if (alert) { 
                sensorSection.classList.add("alert-mode"); 
                status.innerText = "‚ö†Ô∏è NGUY HI·ªÇM!!!"; 
            } else { 
                sensorSection.classList.remove("alert-mode"); 
                status.innerText = "B√¨nh th∆∞·ªùng"; 
            }
            lastUpdate = Date.now();
        }

        db.ref("Temperature").on("value", snap => { updateUI("temp", snap.val()||0, limits.temp, "tempSensor", "tempValue", "tempStatus", "¬∞C"); });
        db.ref("Smoke").on("value", snap => { updateUI("smoke", snap.val()||0, limits.smoke, "smokeSensor", "smokeValue", "smokeStatus", "ppm"); });
        db.ref("Gas").on("value", snap => { updateUI("gas", snap.val()||0, limits.gas, "gasSensor", "gasValue", "gasStatus", "ppm"); });
        db.ref("Flame").on("value", snap => { updateUI("flame", snap.val()||0, limits.flame, "flameSensor", "flameValue", "flameStatus", ""); });

        db.ref("Threshold").on("value", snap => { limits.temp = snap.val(); document.getElementById("thresTemp").innerText = limits.temp; });
        db.ref("SmokeThreshold").on("value", snap => { limits.smoke = snap.val(); document.getElementById("thresSmoke").innerText = limits.smoke; });
        db.ref("GasThreshold").on("value", snap => { limits.gas = snap.val(); document.getElementById("thresGas").innerText = limits.gas; });
        db.ref("FlameThreshold").on("value", snap => { limits.flame = snap.val(); document.getElementById("thresFlame").innerText = limits.flame; });

        function updateVal(path, inputId) {
            let val = document.getElementById(inputId).value;
            if (val && auth.currentUser) {
                db.ref(path).set(Number(val)).then(() => {
                    alert("ƒê√£ l∆∞u!");
                    document.getElementById(inputId).value = "";
                }).catch(e => alert("L·ªói: " + e.message));
            }
        }

        setInterval(() => {
            let badge = document.getElementById("connectionStatus");
            if (Date.now() - lastUpdate < timeoutLimit) {
                badge.className = "status-badge status-online"; badge.innerText = "üü¢ ƒêang k·∫øt n·ªëi";
            } else {
                badge.className = "status-badge status-offline"; badge.innerText = "üî¥ M·∫•t k·∫øt n·ªëi";
            }
        }, 1000);
    </script>
</body>
</html>
