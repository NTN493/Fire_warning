<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng C·∫£nh B√°o Ch√°y Th√¥ng Minh</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 30px;
        }

        /* B·ªë c·ª•c d·∫°ng l∆∞·ªõi */
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Th·∫ª Card */
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 18px;
            color: #666;
            margin-top: 0;
        }

        .value-display {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        /* Hi·ªáu ·ª©ng c·∫£nh b√°o nh·∫•p nh√°y */
        .alert-mode {
            animation: blink-red 0.8s infinite alternate;
            color: white !important;
            background-color: #ff4d4d !important;
        }
        
        .alert-mode .value-display, .alert-mode h2 {
            color: white !important;
        }

        @keyframes blink-red {
            from { background-color: #ff4d4d; }
            to { background-color: #b30000; }
        }

        /* Ph·∫ßn nh·∫≠p li·ªáu */
        .control-group {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        input {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            outline: none;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* Card bi·ªÉu ƒë·ªì r·ªông full */
        .chart-card {
            grid-column: 1 / -1; /* Chi·∫øm h·∫øt chi·ªÅu ngang */
        }
    </style>
</head>
<body>

    <h1>üî• H·ªÜ TH·ªêNG GI√ÅM S√ÅT & C·∫¢NH B√ÅO CH√ÅY</h1>

    <div class="container">
        
        <div class="card" id="tempCard">
            <h2>üå° NHI·ªÜT ƒê·ªò HI·ªÜN T·∫†I</h2>
            <div class="value-display" id="tempValue">-- ¬∞C</div>
            <p>Tr·∫°ng th√°i: <span id="tempStatus">B√¨nh th∆∞·ªùng</span></p>
        </div>

        <div class="card" id="smokeCard">
            <h2>üí® N·ªíNG ƒê·ªò KH√ìI</h2>
            <div class="value-display" id="smokeValue">-- ppm</div>
            <p>Tr·∫°ng th√°i: <span id="smokeStatus">B√¨nh th∆∞·ªùng</span></p>
        </div>

        <div class="card">
            <h2>‚öô C√ÄI ƒê·∫∂T NG∆Ø·ª†NG NHI·ªÜT</h2>
            <div style="font-size: 20px; font-weight: bold; margin: 10px 0;">
                Hi·ªán t·∫°i: <span id="thresholdValue" style="color: #d32f2f;">--</span> ¬∞C
            </div>
            <div class="control-group">
                <input type="number" id="newThreshold" placeholder="Nh·∫≠p ng∆∞·ª°ng m·ªõi...">
                <button onclick="updateThreshold()">C·∫≠p nh·∫≠t</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öô C√ÄI ƒê·∫∂T NG∆Ø·ª†NG KH√ìI</h2>
            <div style="font-size: 20px; font-weight: bold; margin: 10px 0;">
                Hi·ªán t·∫°i: <span id="smokeThresValue" style="color: #d32f2f;">--</span> ppm
            </div>
            <div class="control-group">
                <input type="number" id="newSmokeThres" placeholder="Nh·∫≠p ng∆∞·ª°ng m·ªõi...">
                <button onclick="updateSmokeThreshold()">C·∫≠p nh·∫≠t</button>
            </div>
        </div>

        <div class="card chart-card">
            <h2>üìà BI·ªÇU ƒê·ªí THEO D√ïI TH·ªúI GIAN TH·ª∞C</h2>
            <canvas id="myChart" height="100"></canvas>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // 1. C·∫§U H√åNH FIREBASE (Th√¥ng tin c·ªßa anh)
        const firebaseConfig = {
            apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk",
            authDomain: "fire-warning-3f43e.firebaseapp.com",
            databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-warning-3f43e",
            storageBucket: "fire-warning-3f43e.firebasestorage.app",
            messagingSenderId: "216206579900",
            appId: "1:216206579900:web:aa5f46d236923b921418b9"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. KH·ªûI T·∫†O BI·ªÇU ƒê·ªí (CHART.JS)
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Tr·ª•c th·ªùi gian
                datasets: [{
                    label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    tension: 0.4, // ƒê∆∞·ªùng cong m·ªÅm
                    fill: true
                }, {
                    label: 'Kh√≥i (PPM)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                animation: { duration: 0 } // T·∫Øt hi·ªáu ·ª©ng l∆∞·ªõt ƒë·ªÉ ƒë·ª° gi·∫≠t
            }
        });

        // 3. BI·∫æN TO√ÄN C·ª§C (L∆∞u gi√° tr·ªã m·ªõi nh·∫•t)
        let currentTemp = 0;
        let currentSmoke = 0;
        let tempLimit = 100;
        let smokeLimit = 100;

        // 4. L·∫ÆNG NGHE D·ªÆ LI·ªÜU T·ª™ FIREBASE
        
        // --- NHI·ªÜT ƒê·ªò ---
        db.ref("Temperature").on("value", (snap) => {
            currentTemp = snap.val() || 0;
            document.getElementById("tempValue").innerText = currentTemp + " ¬∞C";
            
            // Ki·ªÉm tra c·∫£nh b√°o
            let card = document.getElementById("tempCard");
            let status = document.getElementById("tempStatus");
            if(currentTemp >= tempLimit) {
                card.classList.add("alert-mode");
                status.innerText = "QU√Å NHI·ªÜT !!!";
            } else {
                card.classList.remove("alert-mode");
                status.innerText = "B√¨nh th∆∞·ªùng";
            }
        });

        // --- KH√ìI ---
        db.ref("Smoke").on("value", (snap) => {
            currentSmoke = snap.val() || 0;
            document.getElementById("smokeValue").innerText = currentSmoke + " ppm";

            // Ki·ªÉm tra c·∫£nh b√°o
            let card = document.getElementById("smokeCard");
            let status = document.getElementById("smokeStatus");
            if(currentSmoke >= smokeLimit) {
                card.classList.add("alert-mode");
                status.innerText = "C√ì KH√ìI !!!";
            } else {
                card.classList.remove("alert-mode");
                status.innerText = "B√¨nh th∆∞·ªùng";
            }
        });

        // --- NG∆Ø·ª†NG NHI·ªÜT ---
        db.ref("Threshold").on("value", (snap) => {
            tempLimit = snap.val();
            document.getElementById("thresholdValue").innerText = tempLimit;
        });

        // --- NG∆Ø·ª†NG KH√ìI ---
        db.ref("SmokeThreshold").on("value", (snap) => {
            smokeLimit = snap.val();
            document.getElementById("smokeThresValue").innerText = smokeLimit;
        });

        // 5. C·∫¨P NH·∫¨T BI·ªÇU ƒê·ªí (Loop 2 gi√¢y/l·∫ßn)
        setInterval(() => {
            let now = new Date().toLocaleTimeString();
            
            // Gi·ªØ t·ªëi ƒëa 20 ƒëi·ªÉm d·ªØ li·ªáu ƒë·ªÉ kh√¥ng b·ªã lag
            if (myChart.data.labels.length > 20) {
                myChart.data.labels.shift();
                myChart.data.datasets[0].data.shift();
                myChart.data.datasets[1].data.shift();
            }

            // Th√™m d·ªØ li·ªáu m·ªõi v√†o bi·ªÉu ƒë·ªì
            myChart.data.labels.push(now);
            myChart.data.datasets[0].data.push(currentTemp);
            myChart.data.datasets[1].data.push(currentSmoke);
            
            myChart.update();
        }, 2000); // 2000ms = 2 gi√¢y

        // 6. H√ÄM X·ª¨ L√ù N√öT B·∫§M (C√ì M·∫¨T KH·∫®U)
        function checkPassword() {
            let pass = prompt("üîí Nh·∫≠p m·∫≠t kh·∫©u Admin:", "");
            if (pass === "123456") return true; // ƒê·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y
            else {
                alert("Sai m·∫≠t kh·∫©u!");
                return false;
            }
        }

        function updateThreshold() {
            if(!checkPassword()) return;
            let val = document.getElementById("newThreshold").value;
            if(val) {
                db.ref("Threshold").set(Number(val));
                alert("ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ª°ng nhi·ªát ƒë·ªô!");
                document.getElementById("newThreshold").value = "";
            }
        }

        function updateSmokeThreshold() {
            if(!checkPassword()) return;
            let val = document.getElementById("newSmokeThres").value;
            if(val) {
                db.ref("SmokeThreshold").set(Number(val));
                alert("ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ª°ng kh√≥i!");
                document.getElementById("newSmokeThres").value = "";
            }
        }

    </script>
</body>
</html>
