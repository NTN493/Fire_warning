<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»‡ Thá»‘ng Cáº£nh BÃ¡o ChÃ¡y ThÃ´ng Minh</title>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        h1 { text-align: center; color: #d32f2f; margin-bottom: 30px; text-transform: uppercase; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin: 0 auto; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
        
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .card h2 { font-size: 18px; margin-bottom: 10px; color: #444; }
        .value-display { font-size: 40px; font-weight: bold; margin: 5px 0 10px 0; }
        .status-text { font-size: 14px; color: #666; }
        
        .threshold-box { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; display: none; /* áº¨n máº·c Ä‘á»‹nh */ }
        .threshold-box input { width: 60%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .threshold-box button { padding: 10px 15px; border: none; background: #1976d2; color: white; border-radius: 8px; cursor: pointer; }
        .threshold-value { color: red; font-weight: bold; }

        .alert-mode { background-color: #ff4d4d !important; color: white !important; animation: pulse 1.5s infinite; }
        .alert-mode h2, .alert-mode .value-display, .alert-mode .status-text { color: white !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .status-badge { padding: 6px 15px; border-radius: 20px; color: white; font-weight: bold; }
        .status-offline { background: #d32f2f; }
        .status-online { background: #2e7d32; }

        /* KHUNG ÄÄ‚NG NHáº¬P */
        #loginSection { text-align: center; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; max-width: 400px; margin-left: auto; margin-right: auto; }
        #userInfo { display: none; text-align: center; margin-bottom: 20px; }
        .btn-logout { background: #555; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Há»‡ Thá»‘ng Cáº£nh BÃ¡o ChÃ¡y ThÃ´ng Minh</h1>
    
    <div style="text-align:center; margin-bottom: 20px;">
        <span id="connectionStatus" class="status-badge status-offline">ğŸ”´ Äang tÃ¬m thiáº¿t bá»‹...</span>
    </div>

    <div id="loginSection">
        <h3>ğŸ”’ ÄÄƒng nháº­p Admin Ä‘á»ƒ chá»‰nh sá»­a</h3>
        <input type="email" id="email" placeholder="Email (vÃ­ dá»¥: admin@fire.com)" style="padding:8px; width: 60%; margin-bottom: 5px;">
        <input type="password" id="password" placeholder="Máº­t kháº©u" style="padding:8px; width: 60%;">
        <br><br>
        <button onclick="login()" style="padding:8px 20px; background:#d32f2f; color:white; border:none; border-radius:5px; cursor:pointer;">ÄÄƒng nháº­p</button>
    </div>

    <div id="userInfo">
        <span>ğŸ‘¤ Xin chÃ o, <b>Admin</b>! Báº¡n Ä‘ang á»Ÿ cháº¿ Ä‘á»™ chá»‰nh sá»­a.</span>
        <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>

    <div class="container">
        <div class="card">
            <div class="sensor-section" id="tempSensor">
                <h2>ğŸŒ¡ Nhiá»‡t Ä‘á»™</h2>
                <div class="value-display" id="tempValue">-- Â°C</div>
                <div class="status-text" id="tempStatus">Äang táº£i...</div>
            </div>
            <div style="margin-top:10px; font-size:12px;">NgÆ°á»¡ng bÃ¡o Ä‘á»™ng: <b id="thresTemp" class="threshold-value">--</b></div>
            <div class="threshold-box admin-controls">
                <input type="number" id="newThresTemp" placeholder="Nháº­p ngÆ°á»¡ng má»›i...">
                <button onclick="updateVal('Threshold','newThresTemp')">LÆ°u</button>
            </div>
        </div>
        
        <div class="card">
            <div class="sensor-section" id="smokeSensor">
                <h2>ğŸ’¨ Ná»“ng Ä‘á»™ khÃ³i</h2>
                <div class="value-display" id="smokeValue">-- ppm</div>
                <div class="status-text" id="smokeStatus">Äang táº£i...</div>
            </div>
            <div style="margin-top:10px; font-size:12px;">NgÆ°á»¡ng bÃ¡o Ä‘á»™ng: <b id="thresSmoke" class="threshold-value">--</b></div>
            <div class="threshold-box admin-controls">
                <input type="number" id="newThresSmoke" placeholder="Nháº­p ngÆ°á»¡ng má»›i...">
                <button onclick="updateVal('SmokeThreshold','newThresSmoke')">LÆ°u</button>
            </div>
        </div>

        <div class="card">
            <div class="sensor-section" id="gasSensor">
                <h2>â˜  Ná»“ng Ä‘á»™ Gas</h2>
                <div class="value-display" id="gasValue">-- ppm</div>
                <div class="status-text" id="gasStatus">Äang táº£i...</div>
            </div>
            <div style="margin-top:10px; font-size:12px;">NgÆ°á»¡ng bÃ¡o Ä‘á»™ng: <b id="thresGas" class="threshold-value">--</b></div>
            <div class="threshold-box admin-controls">
                <input type="number" id="newThresGas" placeholder="Nháº­p ngÆ°á»¡ng má»›i...">
                <button onclick="updateVal('GasThreshold','newThresGas')">LÆ°u</button>
            </div>
        </div>

        <div class="card">
            <div class="sensor-section" id="flameSensor">
                <h2>ğŸ”¥ Cáº£m biáº¿n lá»­a</h2>
                <div class="value-display" id="flameValue">--</div>
                <div class="status-text" id="flameStatus">Äang táº£i...</div>
            </div>
            <div style="margin-top:10px; font-size:12px;">NgÆ°á»¡ng bÃ¡o Ä‘á»™ng: <b id="thresFlame" class="threshold-value">--</b></div>
            <div class="threshold-box admin-controls">
                <input type="number" id="newThresFlame" placeholder="Nháº­p ngÆ°á»¡ng má»›i...">
                <button onclick="updateVal('FlameThreshold','newThresFlame')">LÆ°u</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk", // API Key cá»§a anh
            authDomain: "fire-warning-3f43e.firebaseapp.com",
            databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-warning-3f43e",
            storageBucket: "fire-warning-3f43e.firebasestorage.app",
            messagingSenderId: "216206579900",
            appId: "1:216206579900:web:aa5f46d236923b921418b9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // ----------------- Xá»¬ LÃ ÄÄ‚NG NHáº¬P -----------------
        function login() {
            const e = document.getElementById("email").value;
            const p = document.getElementById("password").value;
            if(!e || !p) return alert("Vui lÃ²ng nháº­p Email vÃ  Máº­t kháº©u!");

            auth.signInWithEmailAndPassword(e, p)
                .then((userCredential) => {
                    alert("ÄÄƒng nháº­p thÃ nh cÃ´ng!");
                })
                .catch((error) => {
                    alert("Lá»—i: " + error.message);
                });
        }

        function logout() {
            auth.signOut().then(() => { alert("ÄÃ£ Ä‘Äƒng xuáº¥t!"); });
        }

        // Theo dÃµi tráº¡ng thÃ¡i Ä‘Äƒng nháº­p Ä‘á»ƒ áº¨n/Hiá»‡n nÃºt
        auth.onAuthStateChanged((user) => {
            const adminControls = document.querySelectorAll('.admin-controls');
            if (user) {
                // ÄÃ£ Ä‘Äƒng nháº­p
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("userInfo").style.display = "block";
                adminControls.forEach(el => el.style.display = "block");
            } else {
                // ChÆ°a Ä‘Äƒng nháº­p
                document.getElementById("loginSection").style.display = "block";
                document.getElementById("userInfo").style.display = "none";
                adminControls.forEach(el => el.style.display = "none");
            }
        });
        // --------------------------------------------------------

        let data = { temp:0, smoke:0, gas:0, flame:0 };
        let limits = { temp:100, smoke:100, gas:100, flame:100 };
        let lastUpdate = 0; 
        const timeoutLimit = 12000;

        function updateUI(type, val, limit, sensorId, valueId, statusId, unit) {
            document.getElementById(valueId).innerText = val + (unit ? " " + unit : "");
            let sensorSection = document.getElementById(sensorId);
            let status = document.getElementById(statusId);
            
            let alert = (type === "flame") ? (val < limit) : (val >= limit);
            
            if (alert) { 
                sensorSection.classList.add("alert-mode"); 
                status.innerText = "âš ï¸ NGUY HIá»‚M!!!"; 
            } else { 
                sensorSection.classList.remove("alert-mode"); 
                status.innerText = "BÃ¬nh thÆ°á»ng"; 
            }
            lastUpdate = Date.now();
        }

        db.ref("Temperature").on("value", snap => { data.temp = snap.val() || 0; updateUI("temp", data.temp, limits.temp, "tempSensor", "tempValue", "tempStatus", "Â°C"); });
        db.ref("Smoke").on("value", snap => { data.smoke = snap.val() || 0; updateUI("smoke", data.smoke, limits.smoke, "smokeSensor", "smokeValue", "smokeStatus", "ppm"); });
        db.ref("Gas").on("value", snap => { data.gas = snap.val() || 0; updateUI("gas", data.gas, limits.gas, "gasSensor", "gasValue", "gasStatus", "ppm"); });
        db.ref("Flame").on("value", snap => { data.flame = snap.val() || 0; updateUI("flame", data.flame, limits.flame, "flameSensor", "flameValue", "flameStatus", ""); });

        db.ref("Threshold").on("value", snap => { limits.temp = snap.val(); document.getElementById("thresTemp").innerText = limits.temp; });
        db.ref("SmokeThreshold").on("value", snap => { limits.smoke = snap.val(); document.getElementById("thresSmoke").innerText = limits.smoke; });
        db.ref("GasThreshold").on("value", snap => { limits.gas = snap.val(); document.getElementById("thresGas").innerText = limits.gas; });
        db.ref("FlameThreshold").on("value", snap => { limits.flame = snap.val(); document.getElementById("thresFlame").innerText = limits.flame; });

        function updateVal(path, inputId) {
            // Kiá»ƒm tra xem Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a
            if (!auth.currentUser) {
                alert("Báº¡n pháº£i Ä‘Äƒng nháº­p má»›i Ä‘Æ°á»£c sá»­a!");
                return;
            }
            let val = document.getElementById(inputId).value;
            if (val) {
                db.ref(path).set(Number(val)).then(() => {
                    alert("ÄÃ£ lÆ°u thÃ nh cÃ´ng!");
                    document.getElementById(inputId).value = "";
                }).catch(e => {
                    alert("Lá»—i: Báº¡n khÃ´ng cÃ³ quyá»n ghi dá»¯ liá»‡u! " + e.message);
                });
            }
        }

        setInterval(() => {
            let badge = document.getElementById("connectionStatus");
            if (Date.now() - lastUpdate < timeoutLimit) {
                badge.className = "status-badge status-online"; badge.innerText = "ğŸŸ¢ Äang káº¿t ná»‘i";
            } else {
                badge.className = "status-badge status-offline"; badge.innerText = "ğŸ”´ Máº¥t káº¿t ná»‘i";
            }
        }, 1000);
    </script>
</body>
</html>
