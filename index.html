<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng C·∫£nh B√°o Ch√°y Th√¥ng Minh</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- C·∫§U TR√öC GRID CHIA 2 C·ªòT --- */
        .container {
            display: grid;
            /* Chia l√†m 2 c·ªôt b·∫±ng nhau */
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
            max-width: 1000px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông cho g·ªçn */
            margin: 0 auto;
        }

        /* Mobile th√¨ v·ªÅ 1 c·ªôt */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Th·∫ª Card */
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Card Bi·ªÉu ƒë·ªì s·∫Ω chi·∫øm tr·ªçn 2 c·ªôt */
        .chart-card {
            grid-column: span 2;
        }
        
        /* Mobile th√¨ bi·ªÉu ƒë·ªì c≈©ng v·ªÅ 1 c·ªôt */
        @media (max-width: 768px) {
            .chart-card {
                grid-column: span 1;
            }
        }

        .card h2 {
            font-size: 16px;
            color: #888;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .value-display {
            font-size: 42px;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }

        .status-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* C·∫£nh b√°o ƒë·ªè */
        .alert-mode {
            background-color: #ff4d4d !important;
            color: white !important;
            animation: pulse 1s infinite;
        }
        .alert-mode h2, .alert-mode .value-display, .alert-mode .status-text {
            color: white !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Input v√† Button */
        .control-group {
            margin-top: auto; /* ƒê·∫©y xu·ªëng ƒë√°y card */
            padding-top: 15px;
        }
        input {
            width: 60%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.3s;
        }
        button:hover { background-color: #0056b3; }

    </style>
</head>
<body>

    <h1>üî• H·ªá Th·ªëng Gi√°m S√°t An To√†n</h1>

    <div class="container">
        
        <div class="card" id="tempCard">
            <h2>üå° Nhi·ªát ƒë·ªô hi·ªán t·∫°i</h2>
            <div class="value-display" id="tempValue">-- ¬∞C</div>
            <div class="status-text" id="tempStatus">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <div class="card" id="smokeCard">
            <h2>üí® N·ªìng ƒë·ªô kh√≥i</h2>
            <div class="value-display" id="smokeValue">-- ppm</div>
            <div class="status-text" id="smokeStatus">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <div class="card">
            <h2>‚öô C√†i ƒë·∫∑t Ng∆∞·ª°ng Nhi·ªát</h2>
            <div style="font-size: 18px; margin-bottom: 10px;">
                Hi·ªán t·∫°i: <b id="thresholdValue" style="color: #d32f2f;">--</b> ¬∞C
            </div>
            <div class="control-group">
                <input type="number" id="newThreshold" placeholder="Nh·∫≠p m·ª©c c·∫£nh b√°o...">
                <button onclick="updateThreshold()">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>‚öô C√†i ƒë·∫∑t Ng∆∞·ª°ng Kh√≥i</h2>
            <div style="font-size: 18px; margin-bottom: 10px;">
                Hi·ªán t·∫°i: <b id="smokeThresValue" style="color: #d32f2f;">--</b> ppm
            </div>
            <div class="control-group">
                <input type="number" id="newSmokeThres" placeholder="Nh·∫≠p m·ª©c c·∫£nh b√°o...">
                <button onclick="updateSmokeThreshold()">L∆∞u</button>
            </div>
        </div>

        <div class="card chart-card">
            <h2>üìà Bi·ªÉu ƒë·ªì theo d√µi th·ªùi gian th·ª±c</h2>
            <canvas id="myChart" height="100"></canvas>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk",
            authDomain: "fire-warning-3f43e.firebaseapp.com",
            databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fire-warning-3f43e",
            storageBucket: "fire-warning-3f43e.firebasestorage.app",
            messagingSenderId: "216206579900",
            appId: "1:216206579900:web:aa5f46d236923b921418b9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- CHART SETUP ---
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                    data: [],
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Kh√≥i (PPM)',
                    data: [],
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                animation: false,
                interaction: { intersect: false, mode: 'index' },
            }
        });

        // --- VARIABLES ---
        let currentTemp = 0, currentSmoke = 0;
        let tempLimit = 100, smokeLimit = 100;

        // --- FIREBASE LISTENERS ---
        db.ref("Temperature").on("value", snap => {
            currentTemp = snap.val() || 0;
            document.getElementById("tempValue").innerText = currentTemp + " ¬∞C";
            checkAlert("tempCard", "tempStatus", currentTemp, tempLimit, "QU√Å NHI·ªÜT !!!");
        });

        db.ref("Smoke").on("value", snap => {
            currentSmoke = snap.val() || 0;
            document.getElementById("smokeValue").innerText = currentSmoke + " ppm";
            checkAlert("smokeCard", "smokeStatus", currentSmoke, smokeLimit, "PH√ÅT HI·ªÜN KH√ìI !!!");
        });

        db.ref("Threshold").on("value", snap => {
            tempLimit = snap.val();
            document.getElementById("thresholdValue").innerText = tempLimit;
            checkAlert("tempCard", "tempStatus", currentTemp, tempLimit, "QU√Å NHI·ªÜT !!!"); // Ki·ªÉm tra qu√° nhi·ªát
        });

        db.ref("SmokeThreshold").on("value", snap => {
            smokeLimit = snap.val();
            document.getElementById("smokeThresValue").innerText = smokeLimit;
            checkAlert("smokeCard", "smokeStatus", currentSmoke, smokeLimit, "PH√ÅT HI·ªÜN KH√ìI !!!"); // Ki·ªÉm tra kh√≥i
        });

        // --- HELPER FUNCTIONS ---
        function checkAlert(cardId, statusId, val, limit, msg) {
            let card = document.getElementById(cardId);
            let status = document.getElementById(statusId);
            if(val >= limit) {
                card.classList.add("alert-mode");
                status.innerText = "‚ö†Ô∏è " + msg;
            } else {
                card.classList.remove("alert-mode");
                status.innerText = "Tr·∫°ng th√°i: B√¨nh th∆∞·ªùng";
            }
        }

        // Update Chart Loop (2s)
        setInterval(() => {
            let now = new Date().toLocaleTimeString('vi-VN', {hour12: false});
            if (myChart.data.labels.length > 20) {
                myChart.data.labels.shift();
                myChart.data.datasets[0].data.shift();
                myChart.data.datasets[1].data.shift();
            }
            myChart.data.labels.push(now);
            myChart.data.datasets[0].data.push(currentTemp);
            myChart.data.datasets[1].data.push(currentSmoke);
            myChart.update();
        }, 2000);

        // --- BUTTON ACTIONS ---
        function checkPassword() {
            let p = prompt("üîí Nh·∫≠p m·∫≠t kh·∫©u Admin:");
            return (p === "123456");
        }

        function updateThreshold() {
            if(!checkPassword()) { alert("Sai m·∫≠t kh·∫©u!"); return; }
            let val = document.getElementById("newThreshold").value;
            if(val) {
                db.ref("Threshold").set(Number(val));
                alert("ƒê√£ l∆∞u ng∆∞·ª°ng nhi·ªát m·ªõi!");
                document.getElementById("newThreshold").value = "";
            }
        }

        function updateSmokeThreshold() {
            if(!checkPassword()) { alert("Sai m·∫≠t kh·∫©u!"); return; }
            let val = document.getElementById("newSmokeThres").value;
            if(val) {
                db.ref("SmokeThreshold").set(Number(val));
                alert("ƒê√£ l∆∞u ng∆∞·ª°ng kh√≥i m·ªõi!");
                document.getElementById("newSmokeThres").value = "";
            }
        }
    </script>
</body>
</html>


