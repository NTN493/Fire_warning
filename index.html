<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªá Th·ªëng C·∫£nh B√°o Ch√°y</title>
<style>
    :root {
        --primary: #d32f2f;
        --warn: #ff4d4d;
        --ok: #2e7d32;
        --card-bg: #ffffff;
        --shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background: #f5f6fa;
        color: #333;
    }
    /* ================= LOGIN ================= */
    #loginScreen {
        position: fixed; inset:0;
        display:flex; justify-content:center; align-items:center;
        background: linear-gradient(135deg, #d32f2f, #1976d2);
        z-index:1000;
    }
    .login-box {
        width: 330px;
        background:#fff;
        padding:35px;
        border-radius:18px;
        box-shadow:var(--shadow);
        text-align:center;
    }
    .login-box input {
        width:100%; padding:12px; margin:10px 0;
        border-radius:10px; border:1px solid #ccc;
        box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m v·ª° layout */
    }
    .login-box button {
        margin-top:10px;
        width:100%; padding:12px;
        border:none; border-radius:10px;
        background:var(--primary); color:#fff; font-weight:bold;
        cursor:pointer;
    }
    /* ================= MAIN APP ================= */
    #mainApp { display:none; padding:25px; max-width:1000px; margin:auto; }
    h1 {
        text-align:center;
        color:var(--primary);
        font-size:26px;
        margin-bottom:20px;
        font-weight:700;
    }
    /* Logout button */
    #logoutBtn {
        position: absolute; top: 20px; right: 20px;
        padding: 8px 16px; background: #555; color: #fff;
        border: none; border-radius: 10px; cursor: pointer; font-weight: bold;
    }
    #logoutBtn:hover { background: #333; }
    /* Connection badge */
    #connectionStatus {
        display:inline-block; padding:8px 18px; border-radius:20px;
        color:#fff; font-weight:600; margin:0 auto 18px auto;
        display:block; width:max-content;
    }
    .status-online { background:var(--ok); }
    .status-offline { background:var(--primary); }
    /* ================= DASHBOARD LAYOUT ================= */
    .grid {
        display:grid; grid-template-columns: repeat(3, 1fr); gap:22px;
    }
    @media(max-width:800px){ .grid { grid-template-columns:1fr; } }
    /* ================= SENSOR CARD ================= */
    .card {
        background:var(--card-bg); padding:25px;
        border-radius:18px; box-shadow:var(--shadow); transition:0.3s;
        border: 2px solid transparent;
    }
    .card:hover { transform:translateY(-3px); }
    
    /* --- CSS M·ªöI: Giao di·ªán c·∫£nh b√°o --- */
    .card-alert {
        background-color: #ffebee;
        border-color: var(--warn);
        box-shadow: 0 8px 25px rgba(255, 77, 77, 0.2);
    }
    .card-alert h2,
    .card-alert .value { color: #c62828; }
    .card-alert .status { color: var(--warn); font-weight: bold; }
    
    .card h2 {
        margin:0 0 8px 0; font-size:17px; font-weight:600; color:#444;
        display:flex; justify-content:center; gap:6px; align-items:center;
    }
    .value {
        font-size:42px; font-weight:800; margin-top:8px; color:#111;
        text-align: center;
    }
    .status { font-size:14px; margin-top:6px; color:#666; text-align: center; }
    
    /* Threshold area */
    .thres-box {
        margin-top:15px; padding:15px;
        background-color: #ffffff;
        border-radius: 12px;
        border: 1px solid #eee;
        text-align: center;
    }
    .card-alert .thres-box { border-color: #ffcdd2; }
    
    .thres-box input {
        padding:8px 10px; width:50%; border:1px solid #bbb; border-radius:10px;
        margin-bottom: 5px;
    }
    .thres-box button {
        padding:8px 14px; background:#1976d2; color:#fff;
        border:none; border-radius:10px; margin-left:6px; cursor:pointer;
    }
</style>
</head>
<body>
<div id="loginScreen">
    <div class="login-box">
        <h2>üîê ƒêƒÉng nh·∫≠p</h2>
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()">V√†o h·ªá th·ªëng</button>
        <p id="loginError" style="color:red; font-size:13px; display:none;"></p>
    </div>
</div>

<div id="mainApp">
    <button id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    <h1>üî• H·ªá Th·ªëng C·∫£nh B√°o Ch√°y</h1>
    <span id="connectionStatus" class="status-offline">üî¥ M·∫•t k·∫øt n·ªëi</span>
    
    <div class="grid">
        <div class="card">
            <h2>üå° Nhi·ªát ƒë·ªô</h2>
            <div class="value" id="tempValue">--</div>
            <div class="status" id="tempStatus">ƒêang t·∫£i...</div>
            <div class="thres-box">
                Ng∆∞·ª°ng: <b id="thresTemp" style="color:#d32f2f">--</b>
                <br><br>
                <input id="newThresTemp" type="number" placeholder="0-100" min="0" max="100">
                <button onclick="updateVal('Threshold','newThresTemp')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>‚ò† Gas</h2>
            <div class="value" id="gasValue">--</div>
            <div class="status" id="gasStatus">ƒêang t·∫£i...</div>
            <div class="thres-box">
                Ng∆∞·ª°ng: <b id="thresGas" style="color:#d32f2f">--</b>
                <br><br>
                <input id="newThresGas" type="number" placeholder="100-4000" min="100" max="4000">
                <button onclick="updateVal('GasThreshold','newThresGas')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>üî• L·ª≠a</h2>
            <div class="value" id="flameValue">--</div>
            <div class="status" id="flameStatus">ƒêang t·∫£i...</div>
            <div class="thres-box">
                Ng∆∞·ª°ng: <b id="thresFlame" style="color:#d32f2f">--</b>
                <br><br>
                <input id="newThresFlame" type="number" placeholder="0-4095" min="0" max="4095">
                <button onclick="updateVal('FlameThreshold','newThresFlame')">L∆∞u</button>
            </div>
        </div>

        <div class="card">
            <h2>üìû S·ªë ƒëi·ªán tho·∫°i</h2>
            <div class="value" id="phoneValue" style="font-size: 28px; word-break: break-all;">--</div>
            <div class="status">SƒêT nh·∫≠n c·∫£nh b√°o</div>
            <div class="thres-box">
                <span style="font-size: 13px; color: #666;">Nh·∫≠p s·ªë m·ªõi:</span>
                <br><br>
                <input id="newPhone" type="text" placeholder="V√≠ d·ª•: 0939..." maxlength="12">
                <button onclick="updatePhone()">L∆∞u</button>
            </div>
        </div>

    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
    apiKey: "AIzaSyAAoqP-5Kkw_sMJOvLzMd9yMZsto86rQBk",
    authDomain: "fire-warning-3f43e.firebaseapp.com",
    databaseURL: "https://fire-warning-3f43e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "fire-warning-3f43e",
    storageBucket: "fire-warning-3f43e.firebasestorage.app",
    messagingSenderId: "216206579900",
    appId: "1:216206579900:web:aa5f46d236923b921418b9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* ================= LOGIN / LOGOUT ================= */
function login(){
    let email = document.getElementById('email').value;
    let pass = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email,pass)
    .catch(()=> {
        let err = document.getElementById('loginError');
        err.innerText = "Sai email ho·∫∑c m·∫≠t kh·∫©u!";
        err.style.display="block";
    });
}
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user=>{
    if(user){
        document.getElementById('loginScreen').style.display="none";
        document.getElementById('mainApp').style.display="block";
    }else{
        document.getElementById('loginScreen').style.display="flex";
        document.getElementById('mainApp').style.display="none";
    }
});

/* ================= SENSOR UPDATE ================= */
let limits = { temp:100, gas:100, flame:100 };
let lastUpdate = 0;
const timeoutLimit = 10000;

function updateUI(type,val,limit,valueId,statusId){
    const valueEl = document.getElementById(valueId);
    const statusEl = document.getElementById(statusId);
    const cardEl = valueEl.closest('.card');
    
    valueEl.innerText = val;
    
    // Logic: Flame < Limit l√† ch√°y, c√≤n l·∫°i > Limit l√† ch√°y
    let alert = (type==="flame") ? val < limit : val >= limit;
    
    if(alert){
        cardEl.classList.add("card-alert");
        statusEl.innerText="‚ö†Ô∏è Nguy hi·ªÉm!";
    } else {
        cardEl.classList.remove("card-alert");
        statusEl.innerText="B√¨nh th∆∞·ªùng";
    }
    lastUpdate = Date.now();
}

// L·∫Øng nghe d·ªØ li·ªáu
db.ref("Temperature").on("value",snap=>{
    let v=snap.val()||0; updateUI("temp",v,limits.temp,"tempValue","tempStatus");
});
db.ref("Gas").on("value",snap=>{
    let v=snap.val()||0; updateUI("gas",v,limits.gas,"gasValue","gasStatus");
});
db.ref("Flame").on("value",snap=>{
    let v=snap.val()||0; updateUI("flame",v,limits.flame,"flameValue","flameStatus");
});

// L·∫Øng nghe ng∆∞·ª°ng
db.ref("Threshold").on("value",s=>{ limits.temp=s.val(); document.getElementById('thresTemp').innerText=s.val();});
db.ref("GasThreshold").on("value",s=>{ limits.gas=s.val(); document.getElementById('thresGas').innerText=s.val();});
db.ref("FlameThreshold").on("value",s=>{ limits.flame=s.val(); document.getElementById('thresFlame').innerText=s.val();});

/* ================= PHONE NUMBER LOGIC (M·ªöI) ================= */
// L·∫Øng nghe s·ªë ƒëi·ªán tho·∫°i t·ª´ Firebase
db.ref("PhoneNumber").on("value", snap => {
    let val = snap.val() || "Ch∆∞a c√≥";
    document.getElementById('phoneValue').innerText = val;
});

// H√†m c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i
function updatePhone(){
    let rawVal = document.getElementById('newPhone').value;
    if(rawVal === "" || rawVal.length < 9) { 
        alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá!"); 
        return; 
    }
    
    // G·ª≠i l√™n Firebase (key l√† PhoneNumber gi·ªëng trong code ESP32)
    db.ref("PhoneNumber").set(rawVal).then(() => {
        alert("ƒê√£ c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i th√†nh c√¥ng!");
        document.getElementById('newPhone').value="";
    }).catch((e) => { alert("L·ªói k·∫øt n·ªëi m·∫°ng!"); });
}

/* ================= SAVE THRESHOLD ================= */
function updateVal(path, inputId){
    let rawVal = document.getElementById(inputId).value;
    if(rawVal === "") { alert("Vui l√≤ng nh·∫≠p gi√° tr·ªã!"); return; }
    let v = Number(rawVal);
    let min = 0, max = 0; let label = "";
    
    if(path === 'Threshold') { min = 0; max = 100; label = "Nhi·ªát ƒë·ªô"; }
    else if (path === 'GasThreshold') { min = 100; max = 4000; label = "Kh√≠ Gas"; }
    else if (path === 'FlameThreshold') { min = 0; max = 4095; label = "C·∫£m bi·∫øn L·ª≠a"; }
    
    if (v < min || v > max) {
        alert("L·ªñI: Gi√° tr·ªã " + label + " ph·∫£i n·∫±m trong kho·∫£ng " + min + " ƒë·∫øn " + max + "!");
        return;
    }
    
    db.ref(path).set(v).then(() => {
        alert("ƒê√£ c·∫≠p nh·∫≠t " + label + " th√†nh c√¥ng!");
        document.getElementById(inputId).value="";
    }).catch((e) => { alert("L·ªói k·∫øt n·ªëi m·∫°ng!"); });
}

/* ================= CONNECTION MONITOR ================= */
db.ref("Heartbeat").on("value", snap => {
    lastUpdate = Date.now();
});

setInterval(()=>{
    let badge = document.getElementById('connectionStatus');
    if(Date.now()-lastUpdate < timeoutLimit){
        badge.className="status-online";
        badge.innerText="üü¢ ƒêang k·∫øt n·ªëi";
    } else {
        badge.className="status-offline";
        badge.innerText="üî¥ M·∫•t k·∫øt n·ªëi";
    }
},1000);
</script>
</body>
</html>
